{"comments":[{"id":"IC_kwDORALW787ibO5y","author":{"login":"coderabbitai"},"authorAssociation":"NONE","body":"<!-- This is an auto-generated comment: summarize by coderabbit.ai -->\n<!-- This is an auto-generated comment: rate limited by coderabbit.ai -->\n\n> [!WARNING]\n> ## Rate limit exceeded\n> \n> `@syaryn` has exceeded the limit for the number of commits that can be reviewed per hour. Please wait **0 minutes and 17 seconds** before requesting another review.\n> \n> <details>\n> <summary>‚åõ How to resolve this issue?</summary>\n> \n> After the wait time has elapsed, a review can be triggered using the `@coderabbitai review` command as a PR comment. Alternatively, push new commits to this PR.\n> \n> We recommend that you space out your commits to avoid hitting the rate limit.\n> \n> </details>\n> \n> \n> <details>\n> <summary>üö¶ How do rate limits work?</summary>\n> \n> CodeRabbit enforces hourly rate limits for each developer per organization.\n> \n> Our paid plans have higher rate limits than the trial, open-source and free plans. In all cases, we re-allow further reviews after a brief timeout.\n> \n> Please see our [FAQ](https://docs.coderabbit.ai/faq) for further information.\n> \n> </details>\n> \n> \n\n<!-- end of auto-generated comment: rate limited by coderabbit.ai -->\n\n<!-- walkthrough_start -->\n\n<details>\n<summary>üìù Walkthrough</summary>\n\n## Walkthrough\n\nAdds an exported tool `get_index_stats()` in `src/mcp_jp_fts/server.py` that gathers index metadata (from DB, filesystem, and in-memory watched paths) and returns it as a pretty-printed JSON string. Tests were adjusted to call `init_db(conn)` directly to trigger migration checks.\n\n## Changes\n\n| Cohort / File(s) | Summary |\n|---|---|\n| **Index statistics tool** <br> `src/mcp_jp_fts/server.py` | Adds exported `get_index_stats()` (annotated with `@mcp.tool()`) which: computes `total_files` from `documents_meta`, `total_size_bytes` from `DB_PATH` file size if present, `last_scanned` as max `scanned_at`, `watched_directories` from `WATCHED_PATHS` keys, `indexed_directories` from dirname values of indexed paths, `file_extensions` counts, and `db_integrity` via `PRAGMA integrity_check`; returns `json.dumps(..., indent=2)`. |\n| **Tests ‚Äî migration & stats** <br> `tests/test_server.py` | Refactors `test_db_migration_v1_to_v2` to open the pre-populated DB directly, call `server.init_db(conn)` to trigger migration, and assert `documents_fts` is cleared (count == 0). `test_get_index_stats` remains validating stats, indexing, and watching flows using `get_index_stats`, `index_directory`, and `watch_directory`. |\n\n## Sequence Diagram(s)\n\n```mermaid\nsequenceDiagram\n  participant Caller as \"Caller\"\n  participant Server as \"server.get_index_stats()\"\n  participant DB as \"SQLite DB\\n(documents_meta, PRAGMA)\"\n  participant FS as \"Filesystem\\n(documents.db file)\"\n  Server->>DB: open connection, read documents_meta (paths, scanned_at)\n  Server->>FS: stat DB_PATH to get size (if exists)\n  Server->>Server: compute indexed_directories, file_extensions, total_files, last_scanned\n  Server->>DB: PRAGMA integrity_check -> db_integrity\n  Server->>Caller: return JSON string with stats\n  Note right of Server: uses WATCHED_PATHS keys for watched_directories\n```\n\n## Estimated code review effort\n\nüéØ 3 (Moderate) | ‚è±Ô∏è ~20 minutes\n\n> \"üêá  \n> I hop through rows and paths I see,  \n> I count the files and size with glee,  \n> timestamps twinkle, watched lists compile,  \n> a JSON nest to rest awhile,  \n> small paws, big stats ‚Äî a rabbit's file.\"\n\n</details>\n\n<!-- walkthrough_end -->\n\n<!-- pre_merge_checks_walkthrough_start -->\n\n<details>\n<summary>üö• Pre-merge checks | ‚úÖ 3</summary>\n\n<details>\n<summary>‚úÖ Passed checks (3 passed)</summary>\n\n|     Check name     | Status   | Explanation                                                                                                                      |\n| :----------------: | :------- | :------------------------------------------------------------------------------------------------------------------------------- |\n|  Description Check | ‚úÖ Passed | Check skipped - CodeRabbit‚Äôs high-level summary is enabled.                                                                      |\n|     Title check    | ‚úÖ Passed | The title accurately describes the primary change: adding a new get_index_stats tool that is fully implemented in the changeset. |\n| Docstring Coverage | ‚úÖ Passed | Docstring coverage is 80.00% which is sufficient. The required threshold is 80.00%.                                              |\n\n</details>\n\n<sub>‚úèÔ∏è Tip: You can configure your own custom pre-merge checks in the settings.</sub>\n\n</details>\n\n<!-- pre_merge_checks_walkthrough_end -->\n\n<!-- tips_start -->\n\n---\n\n\n\n<sub>Comment `@coderabbitai help` to get the list of available commands and usage tips.</sub>\n\n<!-- tips_end -->\n\n<!-- internal state start -->\n\n\n<!-- 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 -->\n\n<!-- internal state end -->","createdAt":"2026-01-26T10:07:44Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/syaryn/mcp-jp-fts/pull/3#issuecomment-3798789746","viewerDidAuthor":false}],"reviews":[{"id":"PRR_kwDORALW787c27qI","author":{"login":"coderabbitai"},"authorAssociation":"NONE","body":"**Actionable comments posted: 2**\n\n<details>\n<summary>ü§ñ Fix all issues with AI agents</summary>\n\n```\nIn `@src/mcp_jp_fts/server.py`:\n- Around line 712-740: The total_size_bytes is computed before calling get_db(),\nbut get_db() can create/initialize the DB file (DB_PATH) so the size may be\nreported as 0; update get_index_stats to call get_db() (using the existing\nget_db() context/conn code block and documents_meta query) before measuring\nos.path.getsize(DB_PATH) and set stats[\"total_size_bytes\"] after the with\nget_db() block, keeping WATCHED_PATHS and other fields unchanged.\n\nIn `@tests/test_server.py`:\n- Around line 629-657: The test currently starts the global watcher via\nserver.watch_directory(...) but never cleans it up, leaking threads/global\nstate; after the assertions add teardown code to stop and clear the watcher:\ncall server.unwatch_directory(str(tmp_path)) if available (or otherwise call the\nserver's global observer stop/join method, e.g. server.OBSERVER.stop() /\nserver.OBSERVER.join()), and reset the global WATCHED_PATHS to an empty list\n(server.WATCHED_PATHS = []). Ensure the observer is fully stopped before the\ntest exits to avoid interference with other tests.\n```\n\n</details>\n\n<!-- This is an auto-generated comment by CodeRabbit for review status -->","submittedAt":"2026-01-26T10:11:10Z","includesCreatedEdit":false,"reactionGroups":[],"state":"COMMENTED","commit":{"oid":"50e777d37e30d29ff1e8f13e80acf794a59d165a"}},{"id":"PRR_kwDORALW787c3Xg0","author":{"login":"sentry"},"authorAssociation":"NONE","body":"","submittedAt":"2026-01-26T10:44:39Z","includesCreatedEdit":false,"reactionGroups":[],"state":"COMMENTED","commit":{"oid":"2e4ad3e6370e3a2ec149645dcc75815d5ac67d22"}},{"id":"PRR_kwDORALW787c3nLb","author":{"login":"coderabbitai"},"authorAssociation":"NONE","body":"**Actionable comments posted: 1**\n\n<details>\n<summary>ü§ñ Fix all issues with AI agents</summary>\n\n```\nIn `@src/mcp_jp_fts/server.py`:\n- Around line 759-763: The current try/except around conn.execute(\"PRAGMA\nintegrity_check\") swallows all exceptions; change the except to catch\nsqlite3.Error (import sqlite3 if not already) so only SQLite-related errors set\nstats[\"db_integrity\"] = str(e) and other exceptions propagate; update the\nhandler around the integrity check in the function where conn.execute(\"PRAGMA\nintegrity_check\") and stats[\"db_integrity\"] are used.\n```\n\n</details>\n\n<details>\n<summary>‚ôªÔ∏è Duplicate comments (3)</summary><blockquote>\n\n<details>\n<summary>tests/test_server.py (1)</summary><blockquote>\n\n`629-663`: **Clean up watch state after this test.**\n\n`watch_directory()` starts the global observer and mutates `WATCHED_PATHS`; without teardown it can leak threads/state into other tests.\n\n \n<details>\n<summary>üßπ Suggested cleanup</summary>\n\n```diff\n-        # 3. Watch directory\n-        server.watch_directory(str(tmp_path))\n-        \n-        stats_json = server.get_index_stats()\n-        stats = json.loads(stats_json)\n-        assert str(tmp_path) in stats[\"watched_directories\"]\n+        # 3. Watch directory\n+        server.watch_directory(str(tmp_path))\n+        try:\n+            stats_json = server.get_index_stats()\n+            stats = json.loads(stats_json)\n+            assert str(tmp_path) in stats[\"watched_directories\"]\n+        finally:\n+            if server.observer.is_alive():\n+                server.observer.stop()\n+                server.observer.join()\n+            server.WATCHED_PATHS.clear()\n```\n</details>\n\n</blockquote></details>\n<details>\n<summary>src/mcp_jp_fts/server.py (2)</summary><blockquote>\n\n`729-733`: **Move `total_size_bytes` calculation after `get_db()`.**\n\n`get_db()` can create/initialize the DB, so measuring size before that can return `0` on first call.\n\n \n<details>\n<summary>üõ†Ô∏è Suggested fix</summary>\n\n```diff\n-    # DB stats\n-    if os.path.exists(DB_PATH):\n-        stats[\"total_size_bytes\"] = os.path.getsize(DB_PATH)\n-        \n     with get_db() as conn:\n         # Get counts and timestamps\n         row = conn.execute(\"SELECT count(*), MAX(scanned_at) FROM documents_meta\").fetchone()\n         if row:\n             stats[\"total_files\"] = row[0]\n             if row[1]:\n                 from datetime import datetime\n                 # Convert unix timestamp to ISO 8601 string\n                 stats[\"last_scanned\"] = datetime.fromtimestamp(row[1]).isoformat()\n+    # DB stats (after init_db may create the file)\n+    if os.path.exists(DB_PATH):\n+        stats[\"total_size_bytes\"] = os.path.getsize(DB_PATH)\n```\n</details>\n\n---\n\n`739-741`: **Make `last_scanned` timezone-aware (UTC).**\n\n`datetime.fromtimestamp()` without tz yields a local-time, timezone-naive value; this makes `last_scanned` vary by server timezone.\n\n  \n<details>\n<summary>üõ†Ô∏è Suggested fix</summary>\n\n```diff\n-                from datetime import datetime\n-                # Convert unix timestamp to ISO 8601 string\n-                stats[\"last_scanned\"] = datetime.fromtimestamp(row[1]).isoformat()\n+                from datetime import datetime, timezone\n+                # Convert unix timestamp to ISO 8601 string (UTC, timezone-aware)\n+                stats[\"last_scanned\"] = datetime.fromtimestamp(row[1], tz=timezone.utc).isoformat()\n```\n</details>\n\n```web\nPython datetime.fromtimestamp timezone behavior and best practice for UTC ISO strings\n```\n\n</blockquote></details>\n\n</blockquote></details>\n\n<details>\n<summary>üßπ Nitpick comments (1)</summary><blockquote>\n\n<details>\n<summary>tests/test_server.py (1)</summary><blockquote>\n\n`610-626`: **Ensure the migration test closes the DB even on assertion failures.**\n\nUse a context manager so the connection is always closed if an assertion fails mid-test.\n\n\n<details>\n<summary>‚ôªÔ∏è Proposed fix</summary>\n\n```diff\n-        conn = sqlite3.connect(db_path)\n-        server.init_db(conn) # This triggers the check\n-        \n-        # Check that documents_fts was cleared\n-        count = conn.execute(\"SELECT count(*) FROM documents_fts\").fetchone()[0]\n-        assert count == 0\n-        conn.close()\n+        with sqlite3.connect(db_path) as conn:\n+            server.init_db(conn) # This triggers the check\n+            \n+            # Check that documents_fts was cleared\n+            count = conn.execute(\"SELECT count(*) FROM documents_fts\").fetchone()[0]\n+            assert count == 0\n```\n</details>\n\n</blockquote></details>\n\n</blockquote></details>\n\n<!-- This is an auto-generated comment by CodeRabbit for review status -->","submittedAt":"2026-01-26T11:05:57Z","includesCreatedEdit":false,"reactionGroups":[],"state":"COMMENTED","commit":{"oid":"1f35632ec5eb246bc218f78508f47c6fb631cfb5"}}]}
